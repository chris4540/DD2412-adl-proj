"""
step 0: generator mean loss = tf.Tensor(0.014180373, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(1.3285333, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(1.2741399, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(1.1283287, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(0.9067144, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(0.7870306, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(0.68217236, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(0.61414737, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(0.5515259, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(0.4972605, shape=(), dtype=float32)
step 0: studnt mean loss = tf.Tensor(0.45977315, shape=(), dtype=float32)
step 2: generator mean loss = tf.Tensor(0.005501293, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.37968048, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.39047435, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.39184454, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.3920217, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.39398333, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.39676142, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.39869943, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.39838427, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.39489654, shape=(), dtype=float32)
step 2: studnt mean loss = tf.Tensor(0.38812202, shape=(), dtype=float32)
step 4: generator mean loss = tf.Tensor(0.0037993204, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.30584213, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.301944, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.2975981, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.29313838, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.2887604, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.28448722, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.28020456, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.27577433, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.27115685, shape=(), dtype=float32)
step 4: studnt mean loss = tf.Tensor(0.2665002, shape=(), dtype=float32)
step 6: generator mean loss = tf.Tensor(0.0028274104, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.24397402, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.2405125, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.23695543, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.23345421, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.23016867, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.22711487, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.2241538, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.22119698, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.21822427, shape=(), dtype=float32)
step 6: studnt mean loss = tf.Tensor(0.2152611, shape=(), dtype=float32)
step 8: generator mean loss = tf.Tensor(0.002211699, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.18817346, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.186019, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.18388271, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.18185325, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.17992361, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.17802712, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.17611618, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.17420101, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.17232828, shape=(), dtype=float32)
step 8: studnt mean loss = tf.Tensor(0.17052607, shape=(), dtype=float32)
step 10: generator mean loss = tf.Tensor(0.0018336197, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.15289712, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.15147632, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.15008436, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.14871295, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.14735824, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.14602281, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.14471197, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.1434285, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.14217076, shape=(), dtype=float32)
step 10: studnt mean loss = tf.Tensor(0.14093445, shape=(), dtype=float32)
step 12: generator mean loss = tf.Tensor(0.0015616595, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12859035, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12758482, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12659514, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12562063, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.124660775, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12371535, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12278432, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12186756, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12096472, shape=(), dtype=float32)
step 12: studnt mean loss = tf.Tensor(0.12007525, shape=(), dtype=float32)
step 14: generator mean loss = tf.Tensor(0.0013602586, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.111052744, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.11030227, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.10956211, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.10883213, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.10811209, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.10740171, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.10670068, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.10600882, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.10532599, shape=(), dtype=float32)
step 14: studnt mean loss = tf.Tensor(0.10465207, shape=(), dtype=float32)
step 16: generator mean loss = tf.Tensor(0.0012056459, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09778719, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09720787, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09663557, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09607019, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.095511585, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09495964, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09441423, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09387523, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09334254, shape=(), dtype=float32)
step 16: studnt mean loss = tf.Tensor(0.09281605, shape=(), dtype=float32)
step 18: generator mean loss = tf.Tensor(0.0010849698, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.08747781, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.087021075, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.08656931, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.08612243, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.08568035, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.08524301, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.08481032, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.084382206, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.0839586, shape=(), dtype=float32)
step 18: studnt mean loss = tf.Tensor(0.083539434, shape=(), dtype=float32)
"""
import tensorflow as tf
tf.compat.v1.enable_eager_execution(config=None, device_policy=None,execution_mode=None)
from net.generator import NavieGenerator
from utils.cosine_anealing import CosineAnnealingScheduler
from utils.losses import *
from tensorflow.keras.optimizers import Adam
from net.wide_resnet import WideResidualNetwork
# from train_scratch import *
import numpy as np

z_dim = 100
batch_size = 128
ng_batches = 1
ns_batches = 10
attn_beta = 250
total_n_pseudo_batches = 20
n_generator_items = ng_batches + ns_batches
total_batches = 0
student_lr = 2e-3
generator_lr = 1e-3
number_of_batches = 10

# teacher_model = WideResidualNetwork(16, 1, input_shape=(32, 32, 3), dropout_rate=0.0, output_activations=True)
# teacher_model.load_weights('saved_models/cifar10_WRN-16-1_model.005.h5')

teacher_model = WideResidualNetwork(40, 2, input_shape=(32, 32, 3), dropout_rate=0.0, output_activations=True)
teacher_model.load_weights('saved_models/cifar10_WRN-40-2_model.h5')

student_model = WideResidualNetwork(16, 1, input_shape=(32, 32, 3), dropout_rate=0.0, output_activations=True)
student_optimizer=Adam(learning_rate=student_lr)
student_scheduler = CosineAnnealingScheduler(T_max=number_of_batches, eta_max=student_lr, eta_min=0)

generator_model = NavieGenerator(input_dim=100)
generator_optimizer=Adam(learning_rate=generator_lr)
generator_scheduler = CosineAnnealingScheduler(T_max=number_of_batches, eta_max=generator_lr, eta_min=0)

student_model.trainable = True
teacher_model.trainable = False
generator_model.trainable = True

gen_loss_metric = tf.keras.metrics.Mean()
stu_loss_metric = tf.keras.metrics.Mean()

def cosine_lr_schedule(epoch, T_max, eta_max, eta_min=0):
    lr = eta_min + (eta_max - eta_min) * (1 + np.cos(np.pi * epoch / T_max)) / 2
    return lr

for total_batches in range(total_n_pseudo_batches):
    # sample from latern space to make an image
    z = tf.random.normal([batch_size, z_dim])

    # Generator training
    for ng in range(ng_batches):
        with tf.GradientTape() as gtape:
            pseudo_images = generator_model(z)
            teacher_logits, *teacher_activations = teacher_model(pseudo_images)
            student_logits, *student_activations = student_model(pseudo_images)
            generator_loss = kd_loss(tf.math.softmax(teacher_logits), tf.math.softmax(student_logits))

        gen_grads = gtape.gradient(generator_loss, generator_model.trainable_weights)

        #cosine annealing for learning rate
        generator_optimizer.learning_rate = cosine_lr_schedule(total_batches, total_n_pseudo_batches, generator_lr)

        #update gradient
        generator_optimizer.apply_gradients(zip(gen_grads, generator_model.trainable_weights))

        gen_loss_metric(generator_loss)

        if total_batches % 2 == 0:
            print('step %s: generator mean loss = %s' % (total_batches, gen_loss_metric.result()))

    # Student training
    for ns in range(ns_batches):
        with tf.GradientTape() as stape:
            pseudo_images = generator_model(z)
            teacher_logits, *teacher_activations = teacher_model(pseudo_images)
            student_logits, *student_activations = student_model(pseudo_images)
            std_loss = student_loss(teacher_logits, teacher_activations,
                                student_logits, student_activations, attn_beta)

        st_grads = stape.gradient(std_loss, student_model.trainable_weights)

        student_optimizer.learning_rate = cosine_lr_schedule(total_batches, total_n_pseudo_batches, student_lr)
        student_optimizer.apply_gradients(zip(st_grads, student_model.trainable_weights))

        stu_loss_metric(std_loss)

        if total_batches % 2 == 0:
            print('step %s: studnt mean loss = %s' % (total_batches, stu_loss_metric.result()))
